# Release Workflow for Arca Verborum

This document describes how to create and publish new releases of Arca Verborum to Zenodo.

## Overview

The release system consists of:
- `prepare_release.py` - Automates release preparation (creates both full and core ZIP archives)
- `zenodo_publish.py` - Handles Zenodo API interactions
- `templates/` - Jinja2 templates for documentation
- `zenodo.metadata.yml` - Zenodo metadata configuration

**Note:** Starting from this version, each release includes TWO archives:
- `arcaverborum_YYYYMMDD.zip` - Full collection (all 149 datasets)
- `arcaverborum_core_YYYYMMDD.zip` - Core collection (9 curated datasets)

## Prerequisites

1. Install dependencies:
   ```bash
   pip install -r requirements.txt
   ```

2. Set up Zenodo API tokens:
   - **Sandbox (for testing):** Get token from https://sandbox.zenodo.org/account/settings/applications/tokens/new/
   - **Production:** Get token from https://zenodo.org/account/settings/applications/tokens/new/

   ```bash
   export ZENODO_SANDBOX_TOKEN="your-sandbox-token"  # For testing
   export ZENODO_TOKEN="your-production-token"       # For real releases
   ```

## Release Process

### Step 1: Clone Datasets

Clone the Lexibank datasets (use `--core-only` for faster setup if testing):

```bash
# Clone all datasets (required for full release)
python clone_lexibank.py

# Or clone only core datasets (for testing)
python clone_lexibank.py --core-only
```

### Step 2: Run the Merger

Build both collections:

```bash
python merge_cldf_datasets.py
```

This creates:
- `output/full/` - Full collection (all datasets)
- `output/core/` - Core collection (9 curated datasets)

Both directories contain complete CSV files, validation reports, and bibliography.

### Step 3: Prepare the Release

Run the release preparation script:

```bash
# Use today's date as version (YYYYMMDD format)
python prepare_release.py

# Or specify a custom version
python prepare_release.py --version 20251001

# Force overwrite if version already exists
python prepare_release.py --version 20251001 --force

# Create git tag automatically
python prepare_release.py --version 20251001 --git-tag
```

This script will:
1. Load statistics from both `output/full/validation_report.json` and `output/core/validation_report.json`
2. Generate collection-specific `DATASET_DESCRIPTION.md` and `RELEASE_NOTES.md` from templates
3. Create TWO archives:
   - `releases/arcaverborum_YYYYMMDD.zip` (full collection)
   - `releases/arcaverborum_core_YYYYMMDD.zip` (core collection)
4. Each archive contains:
   - All CSV files from respective collection
   - `sources.bib`
   - `validation_report.json`
   - Collection-specific documentation files
5. Compute SHA256 checksums for both archives
6. Update `zenodo.metadata.yml` with version and both file paths
7. Save state to `.zenodo_state.json`

### Step 4: Review the Release

Inspect the generated archives:

```bash
# List archive contents
unzip -l releases/arcaverborum_20251001.zip          # Full collection
unzip -l releases/arcaverborum_core_20251001.zip    # Core collection

# View generated documentation
unzip -p releases/arcaverborum_20251001.zip arcaverborum_20251001/DATASET_DESCRIPTION.md | less
unzip -p releases/arcaverborum_core_20251001.zip arcaverborum_core_20251001/DATASET_DESCRIPTION.md | less
```

Preview the Zenodo metadata:

```bash
ZENODO_TOKEN=dummy python zenodo_publish.py --show
```

### Step 5: Test on Zenodo Sandbox

Always test on sandbox first:

```bash
python zenodo_publish.py --sandbox
```

This will:
1. Create a draft deposition (or new version if concept DOI exists)
2. Upload BOTH ZIP files (full and core)
3. Set metadata
4. Publish to sandbox

Verify the sandbox deposit at: https://sandbox.zenodo.org/

**Note:** Both archives will be uploaded to the same Zenodo record. Users can choose which to download.

### Step 6: Publish to Production Zenodo

Once everything looks good:

```bash
python zenodo_publish.py
```

This will:
1. Check if this is a new release or update to existing concept
2. Create deposition and upload BOTH files
3. Publish and receive DOI
4. Update `.zenodo_state.json` with DOI information

### Step 7: Post-Release

After successful publication:

1. **Update the DOI in documentation** (optional for next release):
   - The DOI is auto-generated by Zenodo
   - For the next release, you can reference the previous DOI in related identifiers

2. **Commit changes**:
   ```bash
   git add .zenodo_state.json zenodo.metadata.yml
   git commit -m "Release version 20251001"
   ```

3. **Create git tag** (if not done in Step 2):
   ```bash
   python prepare_release.py --version 20251001 --git-tag
   ```

4. **Push to GitHub**:
   ```bash
   git push origin master
   git push origin v20251001
   ```

## Version Scheme

- **Format:** `YYYYMMDD` (e.g., `20251001` for October 1, 2025)
- **Same-day revisions:** Append `.N` (e.g., `20251001.1`, `20251001.2`)

## File Structure

```
arcaverborum/
├── .gitignore                    # Excludes output/, releases/, lexibank/
├── .zenodo_state.json           # Release tracking (committed to git)
├── zenodo.metadata.yml          # Zenodo configuration (committed to git)
├── datasets.csv                 # Dataset list with CORE column
├── clone_lexibank.py            # Clone Lexibank repositories
├── merge_cldf_datasets.py       # Main data processing script (builds both collections)
├── prepare_release.py           # Release preparation automation (creates both archives)
├── zenodo_publish.py            # Zenodo API client
├── templates/                   # Documentation templates
│   ├── DATASET_DESCRIPTION.md.j2
│   └── RELEASE_NOTES.md.j2
├── output/                      # Generated data (ignored by git)
│   ├── full/                    # Full collection (all 149 datasets)
│   │   ├── forms.csv
│   │   ├── languages.csv
│   │   ├── parameters.csv
│   │   ├── metadata.csv
│   │   ├── sources.bib
│   │   └── validation_report.json
│   └── core/                    # Core collection (9 curated datasets)
│       ├── forms.csv
│       ├── languages.csv
│       ├── parameters.csv
│       ├── metadata.csv
│       ├── sources.bib
│       └── validation_report.json
└── releases/                    # Release archives (ignored by git)
    ├── arcaverborum_YYYYMMDD.zip          # Full collection archive
    └── arcaverborum_core_YYYYMMDD.zip     # Core collection archive
```

## Troubleshooting

### "Version already released" error

Use `--force` flag:
```bash
python prepare_release.py --version 20251001 --force
```

### Missing files in output/

Clone datasets and run the merger:
```bash
python clone_lexibank.py
python merge_cldf_datasets.py
```

### Zenodo upload fails

- Check your API token is valid
- Verify network connectivity
- Try sandbox first to debug

### Need to update documentation

Edit the templates in `templates/`:
- `DATASET_DESCRIPTION.md.j2` - Main dataset description
- `RELEASE_NOTES.md.j2` - Version-specific notes

Available template variables:
- `{{ version }}` - Release version
- `{{ release_date }}` - Release date
- `{{ forms_count }}` - Total forms
- `{{ languages_count }}` - Total languages
- `{{ parameters_count }}` - Total parameters
- `{{ cognates_datasets }}` - Datasets with cognates
- `{{ glottolog_coverage }}` - % with Glottolog
- `{{ concepticon_coverage }}` - % with Concepticon
- `{{ cognate_coverage }}` - % with cognates
- Plus many more (see `prepare_release.py` for full list)

## Customization

### Adding release notes

Specify changes for non-initial releases:

```bash
python prepare_release.py --version 20251002 \
  --changes "Updated to Lexibank 2024 release" \
  --known-issues "Minor formatting issues in dataset XYZ"
```

### Modifying Zenodo metadata

Edit `zenodo.metadata.yml` directly. The `prepare_release.py` script will update the version and files, but preserve other fields.

## Support

For questions or issues:
- GitHub: https://github.com/tresoldi/arcaverborum/issues
- Email: tiago.tresoldi@lingfil.uu.se
